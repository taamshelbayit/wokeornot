<% layout('layout') %>

<div class="container mt-4">
  <h2 class="text-warning"><%= threadTree.title || 'Untitled Thread' %></h2>
  <p>
    Posted by
    <a href="/profile/<%= threadTree.author._id %>" class="text-warning">
      <%= threadTree.author.firstName %> <%= threadTree.author.lastName %>
    </a>
    on <%= new Date(threadTree.createdAt).toDateString() %>
  </p>
  <div class="post-content mb-3">
    <%= threadTree.content %>
  </div>

  <!-- If current user is the author, show Edit / Delete for the main thread -->
  <% if (
    user &&
    threadTree.author &&
    user._id.toString() === threadTree.author._id.toString()
  ) { %>
    <form
      action="/forum/delete/<%= threadTree._id %>"
      method="POST"
      class="d-inline-block mr-2"
      onsubmit="return confirm('Are you sure you want to delete this thread?');"
    >
      <button type="submit" class="btn btn-danger btn-sm">
        Delete
      </button>
    </form>
    <a href="/forum/edit/<%= threadTree._id %>" class="btn btn-secondary btn-sm">
      Edit
    </a>
  <% } %>

  <!-- Reply form for the main thread -->
  <% if (user) { %>
    <form action="/forum/<%= threadTree._id %>/reply" method="POST" class="mb-4 mt-4">
      <div class="form-group">
        <textarea
          class="form-control form-control-sm"
          name="content"
          rows="3"
          placeholder="Add your reply..."
          required
        ></textarea>
      </div>
      <button type="submit" class="btn btn-warning">Reply</button>
    </form>
  <% } else { %>
    <p>
      You must
      <a href="/auth/login" class="text-warning">login</a>
      to reply.
    </p>
  <% } %>

  <h3 class="text-warning">Replies</h3>
  <% if (threadTree.children && threadTree.children.length > 0) { %>
    <ul class="list-group">
      <% threadTree.children.forEach(function(child) { %>
        <%- include('comment.ejs', { comment: child, user: user }) %>
      <% }) %>
    </ul>
  <% } else { %>
    <p>No replies yet.</p>
  <% } %>
</div>
